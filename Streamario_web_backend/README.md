# Streamario Integration Flow

## æ¦‚è¦
ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯Streamerioãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®çµ±åˆãƒ•ãƒ­ãƒ¼ã‚’èª¬æ˜ã—ã¾ã™ã€‚

## ã‚·ã‚¹ãƒ†ãƒ ãƒ•ãƒ­ãƒ¼

### 1. ã‚²ãƒ¼ãƒ é–‹å§‹ãƒ•ãƒ­ãƒ¼
```
Unityèµ·å‹•
  â†“
WebSocketæ¥ç¶š (/ws-unity)
  â†“
ãƒ«ãƒ¼ãƒ IDç™ºè¡Œ (ULID)
  â†“
DBç™»éŒ² (rooms ãƒ†ãƒ¼ãƒ–ãƒ«)
  â†“
QRã‚³ãƒ¼ãƒ‰/URLç”Ÿæˆ
  â†“
Unityã¸é€šçŸ¥ (room_created)
```

### 2. è¦–è´è€…å‚åŠ ãƒ•ãƒ­ãƒ¼
```
è¦–è´è€…ãŒQRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³
  â†“
Webãƒšãƒ¼ã‚¸ã‚¢ã‚¯ã‚»ã‚¹
  â†“
viewer_id Cookieç¢ºèª
  â†“
ãªã— â†’ æ–°è¦ç™ºè¡Œ (ULID)
ã‚ã‚Š â†’ æ—¢å­˜IDä½¿ç”¨
  â†“
DBç™»éŒ² (viewers ãƒ†ãƒ¼ãƒ–ãƒ«)
```

### 3. ã‚¤ãƒ™ãƒ³ãƒˆé€ä¿¡ãƒ•ãƒ­ãƒ¼
```
è¦–è´è€…ãŒãƒœã‚¿ãƒ³æŠ¼ä¸‹
  â†“
POST /api/rooms/{id}/events
  body: {event_type, viewer_id}
  â†“
ã‚¤ãƒ™ãƒ³ãƒˆDBä¿å­˜ (events ãƒ†ãƒ¼ãƒ–ãƒ«)
  â†“
è¦–è´è€…ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£æ›´æ–° (Redis ZADD)
  â†“
ã‚«ã‚¦ãƒ³ãƒˆå¢—åŠ  (Redis INCR)
  â†“
é–¾å€¤è¨ˆç®— (è¦–è´è€…æ•° Ã— å‹•çš„å€ç‡)
  â†“
é–¾å€¤åˆ°é”ï¼Ÿ
  YES â†’ Unityé€šçŸ¥ (game_event)
        ã‚«ã‚¦ãƒ³ãƒˆãƒªã‚»ãƒƒãƒˆ
  NO  â†’ ãƒ¬ã‚¹ãƒãƒ³ã‚¹è¿”å´
```

### 4. é–¾å€¤è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯
```
è¦–è´è€…æ•°å–å¾— (Redis ZCOUNT)
  â†“
å€ç‡ãƒ†ãƒ¼ãƒ–ãƒ«å‚ç…§
  1-5äºº   â†’ 1.0å€
  6-10äºº  â†’ 1.2å€
  11-20äºº â†’ 1.5å€
  21-50äºº â†’ 2.0å€
  51äººä»¥ä¸Š â†’ 3.0å€
  â†“
è¨ˆç®—: base_threshold Ã— multiplier
  â†“
ä¸Šä¸‹é™ã‚¯ãƒ©ãƒ³ãƒ— (min ~ max)
```

### 5. ã‚²ãƒ¼ãƒ çµ‚äº†ãƒ•ãƒ­ãƒ¼
```
Unityçµ‚äº†é€šçŸ¥ OR POST /api/rooms/{id}/end
  â†“
DBé›†è¨ˆã‚¯ã‚¨ãƒªå®Ÿè¡Œ
  - ã‚¤ãƒ™ãƒ³ãƒˆÃ—è¦–è´è€…é›†è¨ˆ
  - ã‚¤ãƒ™ãƒ³ãƒˆåˆè¨ˆ
  - è¦–è´è€…åˆè¨ˆ
  â†“
ãƒˆãƒƒãƒ—ç®—å‡º
  - ã‚¤ãƒ™ãƒ³ãƒˆåˆ¥ãƒˆãƒƒãƒ—
  - ãƒãƒ¼ãƒ åˆ¥ãƒˆãƒƒãƒ— (skill/enemy)
  - å…¨ä½“ãƒˆãƒƒãƒ—
  â†“
rooms.status = 'ended'
  â†“
Unityã¸ã‚µãƒãƒªãƒ¼é€ä¿¡ (game_end_summary)
  â†“
GET /api/rooms/{id}/results ã§çµæœå–å¾—å¯èƒ½
```

## WebSocketãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä»•æ§˜

### Unity â†’ Backend
ç¾åœ¨æœªä½¿ç”¨ï¼ˆå°†æ¥ã®æ‹¡å¼µç”¨ï¼‰

### Backend â†’ Unity

#### room_created
```json
{
  "type": "room_created",
  "room_id": "01HQ...",
  "qr_code": "https://...",
  "web_url": "https://..."
}
```

#### game_event (åŠ¹æœç™ºå‹•)
```json
{
  "type": "game_event",
  "event_type": "skill1",
  "trigger_count": 10,
  "viewer_count": 25
}
```

#### game_end_summary (çµ‚äº†ã‚µãƒãƒªãƒ¼)
```json
{
  "type": "game_end_summary",
  "top_by_button": {
    "skill1": {"viewer_id": "...", "viewer_name": "...", "count": 50}
  },
  "top_overall": {"viewer_id": "...", "viewer_name": "...", "count": 200},
  "team_tops": {
    "skill": {"viewer_id": "...", "count": 150},
    "enemy": {"viewer_id": "...", "count": 120},
    "all": {"viewer_id": "...", "count": 200}
  }
}
```

## è¨­å®šå¤‰æ›´æ–¹æ³•

### ç®¡ç†APIçµŒç”± (æ¨å¥¨)
```bash
# ã‚¤ãƒ™ãƒ³ãƒˆé–¾å€¤å¤‰æ›´
curl -u admin:password -X PUT http://localhost:8888/admin/config/skill1 \
  -H "Content-Type: application/json" \
  -d '{"base_threshold": 8, "min_threshold": 5, "max_threshold": 60}'

# è¦–è´è€…å€ç‡å¤‰æ›´
curl -u admin:password -X PUT http://localhost:8888/admin/viewer-multipliers \
  -H "Content-Type: application/json" \
  -d '[
    {"max_viewers": 10, "multiplier": 1.0},
    {"max_viewers": 30, "multiplier": 1.5},
    {"max_viewers": 999999, "multiplier": 2.5}
  ]'

# å…¨è¨­å®šç¢ºèª
curl -u admin:password http://localhost:8888/admin/config
```

### ç’°å¢ƒå¤‰æ•°çµŒç”±
```bash
# .env ãƒ•ã‚¡ã‚¤ãƒ«ã«è¿½åŠ 
THRESHOLD_SKILL1_BASE=8
THRESHOLD_SKILL1_MIN=5
THRESHOLD_SKILL1_MAX=60
```

å†èµ·å‹•ãŒå¿…è¦

## ãƒ­ã‚°å‡ºåŠ›ä¾‹

### ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚° (LOG_LEVEL=debug)
```json
{
  "time": "2025-01-15T10:30:00Z",
  "level": "DEBUG",
  "msg": "Threshold calculated",
  "event_type": "skill1",
  "viewer_count": 25,
  "multiplier": 2.0,
  "raw": 10,
  "final": 10,
  "min": 3,
  "max": 50
}
```

### åŠ¹æœç™ºå‹•ãƒ­ã‚°
```json
{
  "time": "2025-01-15T10:30:05Z",
  "level": "INFO",
  "msg": "ğŸ¯ Threshold reached - triggering effect",
  "room_id": "01HQ...",
  "event_type": "skill1",
  "current": 10,
  "threshold": 10
}
```

## ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼
- è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤ãªã—
- ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°å‡ºåŠ›
- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¸500ã‚¨ãƒ©ãƒ¼è¿”å´

### Redisã‚¨ãƒ©ãƒ¼
- ã‚«ã‚¦ãƒ³ãƒˆå¤±æ•—æ™‚: ã‚¨ãƒ©ãƒ¼ãƒ­ã‚° + å‡¦ç†ä¸­æ–­
- è¦–è´è€…æ•°å–å¾—å¤±æ•—æ™‚: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤1ã§ç¶™ç¶š

### WebSocketã‚¨ãƒ©ãƒ¼
- é€ä¿¡å¤±æ•—: ãƒ­ã‚°å‡ºåŠ›ã®ã¿ã€å‡¦ç†ã¯ç¶™ç¶š
- æ¥ç¶šåˆ‡æ–­: è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### DBæ¥ç¶šãƒ—ãƒ¼ãƒ«
- Max Open: 25
- Max Idle: 5
- Max Lifetime: 5åˆ†

### Redisæ¥ç¶šãƒ—ãƒ¼ãƒ«
- Pool Size: 10
- Min Idle: 2

### è¦–è´è€…ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£
- 5åˆ†çª“ (Redis ZSET)
- å¤ã„ãƒ‡ãƒ¼ã‚¿è‡ªå‹•å‰Šé™¤

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### ç®¡ç†API
- Basicèªè¨¼å¿…é ˆ
- ç’°å¢ƒå¤‰æ•°ã§ã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ç®¡ç†

### CORS
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚ªãƒªã‚¸ãƒ³é™å®š
- æœ¬ç•ªç’°å¢ƒã§ã¯`*`ã‚’å‰Šé™¤æ¨å¥¨

### SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–
- Prepared Statementä½¿ç”¨
- sqlxè‡ªå‹•ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—

## ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°

### æ°´å¹³ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°
- ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¬ã‚¹è¨­è¨ˆ
- Rediså…±æœ‰ã§ãƒãƒ«ãƒã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å¯¾å¿œ
- ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼é…ä¸‹ã«è¤‡æ•°å°é…ç½®å¯èƒ½

### å‚ç›´ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°
- æ¥ç¶šãƒ—ãƒ¼ãƒ«è¨­å®šèª¿æ•´
- ãƒ¡ãƒ¢ãƒªå‰²ã‚Šå½“ã¦å¢—åŠ 

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### é–¾å€¤ãŒæ„å›³é€šã‚Šã«å¤‰ã‚ã‚‰ãªã„
1. `GET /admin/config` ã§ç¾åœ¨è¨­å®šç¢ºèª
2. ãƒ­ã‚°ã§è¨ˆç®—éç¨‹ã‚’ç¢ºèª (DEBUG ãƒ¬ãƒ™ãƒ«)
3. è¦–è´è€…æ•°ãŒæ­£ã—ãã‚«ã‚¦ãƒ³ãƒˆã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

### Unityã«é€šçŸ¥ãŒå±Šã‹ãªã„
1. `GET /clients` ã§æ¥ç¶šç¢ºèª
2. WebSocketãƒ­ã‚°ç¢ºèª
3. room_idä¸€è‡´ç¢ºèª

### ã‚«ã‚¦ãƒ³ãƒˆãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œãªã„
1. Redisãƒ­ã‚°ç¢ºèª
2. `redis-cli` ã§æ‰‹å‹•ç¢ºèª: `GET room:{id}:cnt:{type}`
3. æ‰‹å‹•ãƒªã‚»ãƒƒãƒˆ: `DEL room:{id}:cnt:{type}`