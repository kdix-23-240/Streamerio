# 要件定義書

## はじめに

配信者向けの 2D アクションゲームシステムです。配信者が Unity でゲームを操作し、視聴者が Web ページからボタンを押してゲーム内でアイテム補助や敵による妨害などのイベントを発生させることができます。システムは Next.js（フロントエンド）、Go（バックエンド）、Unity（ゲーム）で構成され、リアルタイムな相互作用を提供します。

## 要件

### 要件 1

**ユーザーストーリー:** 配信者として、視聴者が参加できるゲームルームを作成したいので、配信画面に QR コードやリンクを表示できるようにしたい

#### 受け入れ基準

1. WHEN 配信者が Unity でルーム作成を要求 THEN システムは一意のルーム ID を生成し、QR コードと Web リンクを返すこと
2. WHEN ルームが作成される THEN システムはルーム情報をデータベースに保存すること
3. WHEN ルームが作成される THEN システムは WebSocket 接続を確立して Unity との通信を開始すること

### 要件 2

**ユーザーストーリー:** 視聴者として、配信者のゲームに参加したいので、QR コードまたはリンクから Web ページにアクセスしてイベントを発生させたい

#### 受け入れ基準

1. WHEN 視聴者が QR コードまたはリンクをスキャン/クリック THEN システムは有効なルームの Web ページを表示すること
2. WHEN 視聴者が Web ページでボタンを押す THEN システムはイベントを Go サーバに送信すること
3. WHEN イベントが送信される THEN システムは視聴者のアクションをデータベースに記録すること
4. IF ルームが存在しない THEN システムはエラーページを表示すること

### 要件 3

**ユーザーストーリー:** システム管理者として、ゲームバランスを保ちたいので、視聴者のイベントを集約してから Unity に送信したい

#### 受け入れ基準

1. WHEN 視聴者がイベントボタンを押す THEN システムはメモリ内でカウントを増加させること
2. WHEN カウントが設定された閾値（例：5 回）に達する THEN システムは Unity にイベント発火を送信すること
3. WHEN イベントが発火される THEN システムはカウントをリセットすること
4. WHEN システムが再起動される THEN カウント情報は失われても問題ないこと

### 要件 4

**ユーザーストーリー:** 開発者として、将来的にスケーリングに対応したいので、メモリベースのカウンターを Redis に移行できる設計にしたい

#### 受け入れ基準

1. WHEN カウンター機能を実装する THEN システムはインターフェースを使用して抽象化すること
2. WHEN Redis に移行する THEN システムは最小限のコード変更で対応できること
3. WHEN カウンター実装を切り替える THEN システムは設定ファイルまたは環境変数で制御できること

### 要件 5

**ユーザーストーリー:** データアナリストとして、視聴者の参加状況を分析したいので、すべてのイベントデータを記録したい

#### 受け入れ基準

1. WHEN 視聴者がイベントを発生させる THEN システムはタイムスタンプ、ルーム ID、イベントタイプ、視聴者 ID を記録すること
2. WHEN ルームが作成される THEN システムはルーム作成時刻と配信者情報を記録すること
3. WHEN データを記録する THEN システムは将来の統計分析に適した形式で保存すること

### 要件 6

**ユーザーストーリー:** 配信者として、リアルタイムでゲームに反映されるイベントを体験したいので、低遅延での通信を実現したい

#### 受け入れ基準

1. WHEN Unity と Go サーバが通信する THEN システムは WebSocket を使用すること
2. WHEN Web フロントエンドと Go サーバが通信する THEN システムは HTTP API を使用すること
3. WHEN イベントが発火される THEN システムは 1 秒以内に Unity に通知すること

### 要件 7

**ユーザーストーリー:** システム管理者として、システムの安定性を保ちたいので、エラーハンドリングと接続管理を適切に行いたい

#### 受け入れ基準

1. WHEN WebSocket 接続が切断される THEN システムは自動的に再接続を試行すること
2. WHEN データベース接続エラーが発生する THEN システムは適切なエラーレスポンスを返すこと
3. WHEN 無効なルーム ID でアクセスされる THEN システムは 404 エラーを返すこと
4. WHEN システムエラーが発生する THEN システムはログに詳細を記録すること
