# 実装計画

- [ ] 1. プロジェクト構造とコア設定の作成

  - Go プロジェクトのディレクトリ構造を作成（cmd、internal、pkg パッケージ）
  - 基本的な設定ファイル（config.go）とデータベース接続設定を実装
  - 依存関係管理（go.mod）とログ設定を追加
  - _要件: 1.1, 1.2, 1.3_

- [ ] 2. データベーススキーマとモデルの実装

  - [ ] 2.1 データベーススキーマの作成

    - rooms、events、game_events テーブルのマイグレーションファイルを作成
    - インデックスと外部キー制約を適切に設定
    - _要件: 2.2, 5.1, 5.2, 5.3_

  - [ ] 2.2 Go データモデル構造体の実装
    - Room、Event、GameEvent 構造体を model/パッケージに実装
    - JSON タグとデータベースタグを適切に設定
    - バリデーション機能を追加
    - _要件: 2.2, 5.1, 5.2, 5.3_

- [ ] 3. カウンターシステムの抽象化実装

  - [ ] 3.1 カウンターインターフェースの定義

    - Counter インターフェースを pkg/counter/interface.go に実装
    - Increment、GetCount、Reset メソッドを定義
    - _要件: 3.1, 3.2, 4.1, 4.2_

  - [ ] 3.2 メモリベースカウンターの実装

    - MemoryCounter 構造体を pkg/counter/memory.go に実装
    - スレッドセーフなカウント操作を実装
    - 単体テストを作成
    - _要件: 3.1, 3.2, 3.3, 4.1_

  - [ ] 3.3 Redis カウンター実装の準備
    - RedisCounter 構造体を pkg/counter/redis.go に実装（基本構造のみ）
    - 設定による切り替え機能を config.go に追加
    - _要件: 4.1, 4.2, 4.3_

- [ ] 4. データベースリポジトリ層の実装

  - [ ] 4.1 ルームリポジトリの実装

    - RoomRepository インターフェースと実装を repository/room.go に作成
    - Create、GetByID、UpdateStatus メソッドを実装
    - データベース接続エラーハンドリングを追加
    - _要件: 1.2, 2.4, 7.2_

  - [ ] 4.2 イベントリポジトリの実装
    - EventRepository インターフェースと実装を repository/event.go に作成
    - Create、GetByRoomID、GetStats メソッドを実装
    - バッチ挿入機能を追加（パフォーマンス向上）
    - _要件: 2.3, 5.1, 5.2, 5.3_

- [ ] 5. サービス層のビジネスロジック実装

  - [ ] 5.1 ルームサービスの実装

    - RoomService を service/room.go に実装
    - CreateRoom、GetRoom、ValidateRoom メソッドを実装
    - QR コード生成機能を追加
    - _要件: 1.1, 1.2, 2.4_

  - [ ] 5.2 イベントサービスの実装
    - EventService を service/event.go に実装
    - ProcessEvent、TriggerGameEvent メソッドを実装
    - カウンター閾値チェックとリセット機能を実装
    - _要件: 2.3, 3.1, 3.2, 3.3_

- [ ] 6. WebSocket ハンドラーの実装

  - [ ] 6.1 WebSocket 接続管理の実装

    - WebSocketHandler を handler/websocket.go に実装
    - Unity 接続の確立、切断、再接続処理を実装
    - 接続プールとハートビート機能を追加
    - _要件: 1.3, 6.1, 6.3, 7.1_

  - [ ] 6.2 WebSocket メッセージ処理の実装
    - create_room メッセージハンドラーを実装
    - game_event メッセージ送信機能を実装
    - メッセージバリデーションとエラーハンドリングを追加
    - _要件: 1.1, 1.2, 6.3, 7.4_

- [ ] 7. HTTP API ハンドラーの実装

  - [ ] 7.1 ルーム情報取得 API の実装

    - GET /api/rooms/{id} エンドポイントを handler/api.go に実装
    - ルーム存在チェックと有効期限チェックを追加
    - 適切な HTTP ステータスコードとエラーレスポンスを実装
    - _要件: 2.1, 2.4, 7.3_

  - [ ] 7.2 イベント送信 API の実装
    - POST /api/rooms/{id}/events エンドポイントを実装
    - リクエストバリデーションとレート制限を追加
    - イベント処理とカウンター更新を統合
    - _要件: 2.2, 2.3, 3.1, 3.2_

- [ ] 8. Next.js フロントエンドの実装

  - [ ] 8.1 視聴者参加ページの作成

    - pages/room/[id].tsx を実装
    - ルーム情報取得とエラーハンドリングを追加
    - レスポンシブデザインを適用
    - _要件: 2.1, 2.4, 7.3_

  - [ ] 8.2 イベントボタンコンポーネントの実装

    - EventButton コンポーネントを components/EventButton.tsx に実装
    - ヘルプ/妨害ボタンの UI/UX を実装
    - クリック時のフィードバックとローディング状態を追加
    - _要件: 2.2, 2.3_

  - [ ] 8.3 API クライアント機能の実装
    - イベント送信の HTTP クライアント機能を実装
    - エラーハンドリングとリトライ機能を追加
    - TypeScript 型定義を追加
    - _要件: 2.2, 2.3, 6.2_

- [ ] 9. エラーハンドリングとログ機能の実装

  - [ ] 9.1 統一エラーハンドリングの実装

    - APIError 構造体とエラータイプ定義を実装
    - ミドルウェアでの統一エラーレスポンス処理を追加
    - ログ出力機能を統合
    - _要件: 7.2, 7.3, 7.4_

  - [ ] 9.2 構造化ログ機能の実装
    - LogEntry 構造体とログ機能を実装
    - コンポーネント別ログレベル設定を追加
    - ログローテーション設定を追加
    - _要件: 7.4_

- [ ] 10. 統合テストと E2E テストの実装

  - [ ] 10.1 単体テストの作成

    - サービス層、リポジトリ層の単体テストを実装
    - モックオブジェクトを使用したテストを作成
    - テストカバレッジ 80%以上を目標に設定
    - _要件: 全要件のテスト_

  - [ ] 10.2 統合テストの作成

    - WebSocket 通信の統合テストを実装
    - HTTP API の統合テストを実装
    - データベース操作の統合テストを実装
    - _要件: 6.1, 6.2, 6.3_

  - [ ] 10.3 E2E テストシナリオの実装
    - ルーム作成からイベント発火までの完全フローテストを実装
    - 複数視聴者による同時イベント送信テストを実装
    - エラーケースのテストシナリオを実装
    - _要件: 1.1, 1.2, 1.3, 2.1, 2.2, 2.3, 3.1, 3.2, 3.3_

- [ ] 11. 設定とデプロイメント準備

  - [ ] 11.1 環境設定とコンフィグ管理

    - 開発、テスト、本番環境の設定ファイルを作成
    - 環境変数による設定切り替え機能を実装
    - データベース接続設定とカウンター切り替え設定を追加
    - _要件: 4.3_

  - [ ] 11.2 Docker 化とビルド設定
    - Go バックエンドの Dockerfile を作成
    - Next.js フロントエンドの Dockerfile を作成
    - docker-compose.yml でローカル開発環境を構築
    - _要件: システム全体の動作確認_
